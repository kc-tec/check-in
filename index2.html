<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC-TEC Check-In (Session Sync)</title>
    
    <link rel="icon" type="image/png" href="./fav.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./fav.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        #reader { width: 100%; max-width: 400px; margin: 20px auto; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); }
        .modal { transition: opacity 0.3s ease-in-out; }
        .hidden-section { display: none; }
        button:disabled { cursor: not-allowed; filter: grayscale(1); opacity: 0.5; }
        
        /* Progress Bar Styles */
        .progress-segment { height: 24px; border-radius: 12px; position: relative; transition: all 0.3s ease; border: 1px solid rgba(0,0,0,0.05); }
        .progress-segment.done { display: flex; align-items: center; justify-content: center; color: white; border: none; }
        .progress-bg { background-color: #e5e7eb; }
        
        /* Colors */
        .color-am-in { background-color: #f59e0b !important; }  /* Orange */
        .color-am-out { background-color: #3b82f6 !important; } /* Blue */
        .color-pm-in { background-color: #a855f7 !important; }  /* Purple */
        .color-pm-out { background-color: #6366f1 !important; } /* Indigo */
    </style>
    
    <script src="./html5-qrcode.min.js" onerror="loadCDN()"></script>
    <script id="qr-cdn"></script>
    <script>
        function loadCDN() {
            console.warn("Local QR library not found. Falling back to CDN.");
            const script = document.createElement('script');
            script.src = "https://unpkg.com/html5-qrcode";
            document.head.appendChild(script);
        }
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- === AUTH SECTION === -->
    <div id="auth-section" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-2">User Access</h1>
        <p class="text-center text-xs text-gray-500 mb-6 font-medium uppercase tracking-wider">Device Verification Active</p>
        
        <div id="login-form">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" id="auth-name" class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500" placeholder="e.g. San Dara">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700">ID Number</label>
                <input type="text" 
                       id="auth-id" 
                       inputmode="numeric"
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                       class="mt-1 w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500" 
                       placeholder="e.g. 1234">
                <p class="text-[10px] text-gray-400 mt-1">* Digits only. This ID will be locked to this device.</p>
            </div>
            <button onclick="handleAuth()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">
                VERIFY & CONTINUE
            </button>
        </div>
    </div>

    <!-- === MAIN APP SECTION === -->
    <div id="app-section" class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-2xl hidden-section">
        
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-extrabold text-indigo-700">KC-TEC Check-In</h1>
            <button onclick="requestReset()" class="text-[10px] text-gray-400 border border-gray-200 px-2 py-1 rounded hover:bg-gray-50">Admin Reset</button>
        </div>

        <!-- User Info Bar -->
        <div class="text-xs text-center mb-4 bg-gray-50 py-2 rounded border border-gray-100">
            <span class="text-gray-400 uppercase text-[9px] block tracking-widest">Verified User</span>
            <span id="display-user-name" class="font-bold text-indigo-900">...</span> 
            (<span id="display-user-id" class="text-gray-500 italic">...</span>)
        </div>

        <!-- Progress Card -->
        <div class="bg-white border border-gray-100 rounded-2xl p-4 shadow-sm mb-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center text-indigo-600 font-bold text-sm">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <span id="current-date-display">...</span>
                </div>
                <div class="bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full" id="progress-fraction">0/4</div>
            </div>

            <!-- Visual Bar -->
            <div class="grid grid-cols-4 gap-1.5 mb-3">
                <div id="bar-AM-IN" class="progress-segment progress-bg"></div>
                <div id="bar-AM-OUT" class="progress-segment progress-bg"></div>
                <div id="bar-PM-IN" class="progress-segment progress-bg"></div>
                <div id="bar-PM-OUT" class="progress-segment progress-bg"></div>
            </div>

            <!-- Labels and Times -->
            <div class="grid grid-cols-4 text-center">
                <div class="flex flex-col items-center">
                    <span class="text-[9px] font-bold text-gray-600 uppercase">AM In</span>
                    <span id="time-AM-IN" class="text-[9px] text-orange-500 font-mono mt-0.5 whitespace-nowrap">--:-- --</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-[9px] font-bold text-gray-600 uppercase">AM Out</span>
                    <span id="time-AM-OUT" class="text-[9px] text-blue-500 font-mono mt-0.5 whitespace-nowrap">--:-- --</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-[9px] font-bold text-gray-600 uppercase">PM In</span>
                    <span id="time-PM-IN" class="text-[9px] text-purple-500 font-mono mt-0.5 whitespace-nowrap">--:-- --</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-[9px] font-bold text-gray-600 uppercase">PM Out</span>
                    <span id="time-PM-OUT" class="text-[9px] text-indigo-700 font-mono mt-0.5 whitespace-nowrap">--:-- --</span>
                </div>
            </div>
        </div>

        <!-- Scanner Controls Area -->
        <div id="scanner-wrapper">
            <div id="reader-container" class="relative bg-gray-100 p-2 rounded-lg overflow-hidden">
                <div id="reader"></div>
                <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center bg-gray-100/90 hidden z-10">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
                    <p class="ml-4 text-indigo-700 font-semibold text-sm">Syncing...</p>
                </div>
            </div>

            <div id="result-status" class="mt-4 p-3 rounded-lg bg-gray-50 border border-gray-200 text-center">
                <p id="status-message" class="text-sm font-medium text-gray-600">Please select a session below.</p>
            </div>

            <div id="controls-wrapper" class="mt-6">
                <div id="main-controls" class="grid grid-cols-2 gap-3">
                    <button id="am-in-btn" onclick="initiateScan('AM-IN')" class="px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition flex flex-col items-center">
                        <span class="text-[10px] uppercase opacity-80">Morning</span>
                        <span>AM In</span>
                    </button>
                    <button id="am-out-btn" onclick="initiateScan('AM-OUT')" class="px-4 py-3 bg-orange-500 text-white font-bold rounded-lg shadow-md hover:bg-orange-600 transition flex flex-col items-center">
                        <span class="text-[10px] uppercase opacity-80">Morning</span>
                        <span>AM Out</span>
                    </button>
                    <button id="pm-in-btn" onclick="initiateScan('PM-IN')" class="px-4 py-3 bg-indigo-800 text-white font-bold rounded-lg shadow-md hover:bg-indigo-900 transition flex flex-col items-center">
                        <span class="text-[10px] uppercase opacity-80">Afternoon</span>
                        <span>PM In</span>
                    </button>
                    <button id="pm-out-btn" onclick="initiateScan('PM-OUT')" class="px-4 py-3 bg-orange-700 text-white font-bold rounded-lg shadow-md hover:bg-orange-800 transition flex flex-col items-center">
                        <span class="text-[10px] uppercase opacity-80">Afternoon</span>
                        <span>PM Out</span>
                    </button>
                </div>
                <div class="mt-6 flex flex-col space-y-2">
                    <button onclick="toggleLeaveForm()" id="leave-toggle-btn" class="w-full py-2 bg-gray-100 text-indigo-700 font-semibold rounded-lg hover:bg-gray-200 transition text-xs">Request Leave</button>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="viewQR()" class="py-2 bg-indigo-50 text-indigo-700 font-bold rounded-lg border border-indigo-200 hover:bg-indigo-100 transition text-xs flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            View QR
                        </button>
                        <button id="skip-scan-btn" onclick="confirmSkip()" class="py-2 bg-red-50 text-red-600 font-bold rounded-lg border border-red-200 hover:bg-red-100 transition text-xs flex items-center justify-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                            Skip Scan
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="cancel-control" class="mt-6 hidden-section">
            <button onclick="stopScan()" class="w-full px-4 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition">Cancel / Stop Scanner</button>
        </div>

        <!-- Leave Form -->
        <div id="leave-form-container" class="mt-4 p-4 border border-gray-200 rounded-lg bg-gray-50 hidden-section">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Leave Request</h2>
            <form id="leave-form">
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="leave-type" name="type" required class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm">
                        <option value="Annual">Annual Leave</option>
                        <option value="Sick">Sick Leave</option>
                        <option value="Emergency">Emergency / Unpaid</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex space-x-3 mb-3">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">Start</label>
                        <input type="date" id="leave-start-date" required class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">End</label>
                        <input type="date" id="leave-end-date" required class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Reason</label>
                    <textarea id="leave-reason" rows="3" required class="mt-1 w-full p-2 border border-gray-300 rounded-md text-sm"></textarea>
                </div>
                <button type="submit" id="submit-leave-btn" class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 text-sm">Submit Request</button>
            </form>
        </div>
    </div>

    <!-- Modal System -->
    <div id="custom-modal" class="modal fixed inset-0 bg-gray-900/75 flex items-center justify-center p-4 z-50 pointer-events-none opacity-0">
        <div class="bg-white rounded-xl p-6 shadow-2xl w-full max-w-xs transform transition-all scale-95">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">Notification</h3>
            <p id="modal-message" class="text-gray-600 mb-4 text-sm"></p>
            
            <div id="modal-image-container" class="hidden mb-4 overflow-hidden rounded-lg text-center">
                <img id="modal-qr-img" src="qrcode.jpg" class="w-full h-auto mx-auto" alt="QR Code" onerror="this.src='https://placehold.co/400x400?text=QR+Image+Missing'">
            </div>

            <div id="modal-input-container" class="hidden mb-4">
                <input type="password" id="modal-input" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter PIN">
            </div>
            <div class="flex space-x-2">
                <button id="modal-cancel-btn" onclick="closeModal()" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-lg font-medium hidden text-sm">Cancel</button>
                <button id="modal-confirm-btn" onclick="closeModal()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium text-sm">OK</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7Y_SOnkmH2N4YMpjX9d88LilJ8_2TXxpcSZTW0s68bs8Z_tkieCoBK4KAZLa4ilZIYQ/exec";
        const ADMIN_RESET_PIN = "2520";
        const SYNC_TIMEOUT_MS = 12000;

        let currentUser = null;
        let qrScanner = null;
        let scanning = false;
        let currentAction = 'AM-IN';

        const getLocalDate = () => new Date().toLocaleDateString('en-CA'); 

        const getDeviceId = () => {
            let id = localStorage.getItem('kctec_device_id');
            if (!id) {
                id = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
                localStorage.setItem('kctec_device_id', id);
            }
            return id;
        };

        const handleAuth = () => {
            const name = document.getElementById('auth-name').value.trim();
            const id = document.getElementById('auth-id').value.trim();
            if (!name || !id) { showModal('Required', 'Please enter Name and ID.'); return; }
            const pinnedId = localStorage.getItem('kctec_pinned_id');
            if (pinnedId && pinnedId !== id) { showModal('Device Locked', `Device linked to ID: ${pinnedId}.`); return; }
            if (!pinnedId) localStorage.setItem('kctec_pinned_id', id);
            currentUser = { name, id, deviceId: getDeviceId() };
            localStorage.setItem('kctec_checkin_user', JSON.stringify(currentUser));
            showApp();
        };

        const showApp = () => {
            document.getElementById('auth-section').classList.add('hidden-section');
            document.getElementById('app-section').classList.remove('hidden-section');
            const nameEl = document.getElementById('display-user-name');
            const idEl = document.getElementById('display-user-id');
            const dateEl = document.getElementById('current-date-display');
            if (nameEl) nameEl.textContent = currentUser.name;
            if (idEl) idEl.textContent = currentUser.id;
            if (dateEl) dateEl.textContent = new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            updateUI();
        };

        const updateUI = () => {
            const today = getLocalDate();
            let stateData = JSON.parse(localStorage.getItem('kctec_daily_state') || '{}');
            if (stateData.date !== today) {
                stateData = { date: today, history: {} };
                localStorage.setItem('kctec_daily_state', JSON.stringify(stateData));
            }
            const history = stateData.history || {};
            const sequence = ['AM-IN', 'AM-OUT', 'PM-IN', 'PM-OUT'];
            let lastCompleted = 'NONE';
            let completedCount = 0;

            sequence.forEach(key => {
                const bar = document.getElementById(`bar-${key}`);
                const timeEl = document.getElementById(`time-${key}`);
                const cssKey = key.toLowerCase();
                if (history[key]) {
                    bar.className = `progress-segment done color-${cssKey}`;
                    bar.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"/></svg>`;
                    timeEl.textContent = history[key];
                    lastCompleted = key;
                    completedCount++;
                } else {
                    bar.className = 'progress-segment progress-bg';
                    bar.innerHTML = '';
                    timeEl.textContent = '--:-- --';
                }
            });
            document.getElementById('progress-fraction').textContent = `${completedCount}/4`;
            const btns = { 'AM-IN': document.getElementById('am-in-btn'), 'AM-OUT': document.getElementById('am-out-btn'), 'PM-IN': document.getElementById('pm-in-btn'), 'PM-OUT': document.getElementById('pm-out-btn') };
            Object.values(btns).forEach(b => b.disabled = true);
            if (lastCompleted === 'NONE') btns['AM-IN'].disabled = false;
            else if (lastCompleted === 'AM-IN') btns['AM-OUT'].disabled = false;
            else if (lastCompleted === 'AM-OUT') btns['PM-IN'].disabled = false;
            else if (lastCompleted === 'PM-IN') btns['PM-OUT'].disabled = false;
            setStatus(completedCount === 4 ? 'Day Complete' : 'Ready to Scan', completedCount === 4 ? 'success' : 'info');
        };

        const saveProgress = (action, labelSuffix = "") => {
            const today = getLocalDate();
            let stateData = JSON.parse(localStorage.getItem('kctec_daily_state') || '{}');
            const timeStr = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) + labelSuffix;
            stateData.history[action] = timeStr;
            stateData.date = today;
            localStorage.setItem('kctec_daily_state', JSON.stringify(stateData));
            updateUI(); 
        };

        const confirmSkip = () => {
            let activeAction = 'AM-IN';
            const stateData = JSON.parse(localStorage.getItem('kctec_daily_state') || '{}');
            const history = stateData.history || {};
            const sequence = ['AM-IN', 'AM-OUT', 'PM-IN', 'PM-OUT'];
            for(let key of sequence) {
                if(!history[key]) { activeAction = key; break; }
            }
            if(Object.keys(history).length >= 4) { showModal('Finished', 'All sessions are complete.'); return; }

            document.getElementById('modal-title').textContent = "Skip " + activeAction.replace('-',' ');
            document.getElementById('modal-message').textContent = "Record this session as 'SKIPPED'?";
            document.getElementById('modal-input-container').classList.add('hidden');
            document.getElementById('modal-image-container').classList.add('hidden');
            document.getElementById('modal-cancel-btn').classList.remove('hidden');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.textContent = "Yes, Skip";
            confirmBtn.onclick = () => performSkip(activeAction);
            const m = document.getElementById('custom-modal');
            m.classList.remove('opacity-0', 'pointer-events-none');
            m.querySelector('div').classList.remove('scale-95');
        };

        const performSkip = async (action) => {
            closeModal();
            toggleLoading(true);
            const res = await syncToSheets('log_entry', { 
                staffId: currentUser.id, 
                staffName: currentUser.name, 
                storeId: "SKIPPED", 
                type: action + " (SKIPPED)", 
                dist: 0 
            });
            if (res.success) {
                saveProgress(action, " (S)");
                showModal('Skipped', `Session ${action} has been skipped.`);
            } else {
                showModal('Sync Error', 'Could not skip. Check connection.');
            }
            toggleLoading(false);
        };

        const syncToSheets = async (action, data) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), SYNC_TIMEOUT_MS);
            try {
                const payload = { action, ...data, deviceId: currentUser.deviceId, timestamp: new Date().toISOString() };
                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload), signal: controller.signal });
                return { success: true };
            } catch (e) {
                return { success: false, error: e.name === 'AbortError' ? 'Timeout' : 'Network' };
            } finally {
                clearTimeout(timeoutId);
            }
        };

        const initiateScan = (action) => { currentAction = action; startScan(); };
        const startScan = () => {
            if (scanning) return;
            qrScanner = new Html5Qrcode("reader");
            qrScanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => handleScanSuccess(text))
            .then(() => {
                scanning = true;
                document.getElementById('controls-wrapper').classList.add('hidden-section');
                document.getElementById('cancel-control').classList.remove('hidden-section');
            }).catch(() => setStatus('Camera Error', 'error'));
        };
        const stopScan = async () => {
            if (qrScanner && scanning) { await qrScanner.stop(); scanning = false; document.getElementById('controls-wrapper').classList.remove('hidden-section'); document.getElementById('cancel-control').classList.add('hidden-section'); }
        };

        const handleScanSuccess = async (text) => {
            await stopScan();
            toggleLoading(true);
            try {
                const parts = text.split('|');
                if (parts.length < 4) throw new Error('Invalid QR');
                const qr = { 
                    storeId: parts[0], // Store ID from QR code
                    lat: parseFloat(parts[1]), 
                    lon: parseFloat(parts[2]), 
                    radius: parseInt(parts[3]) 
                };
                
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const dist = haversineDistance(pos.coords.latitude, pos.coords.longitude, qr.lat, qr.lon);
                    if (dist > qr.radius) { toggleLoading(false); showModal('Out of Range', `Dist: ${Math.round(dist)}m. Limit: ${qr.radius}m.`); return; }
                    
                    // FIXED: Now passing qr.storeId in the payload
                    const res = await syncToSheets('log_entry', { 
                        staffId: currentUser.id, 
                        staffName: currentUser.name, 
                        storeId: qr.storeId, 
                        type: currentAction, 
                        dist: Math.round(dist) 
                    });
                    
                    toggleLoading(false);
                    if (res.success) { saveProgress(currentAction); showModal('Success', `${currentAction} saved.`); }
                    else { showModal('Sync Error', 'Try again.'); }
                }, () => { toggleLoading(false); showModal('GPS Error', 'Enable GPS.'); }, { enableHighAccuracy: true, timeout: 8000 });
            } catch (err) { toggleLoading(false); showModal('Error', err.message); }
        };

        const haversineDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3;
            const p1 = lat1 * Math.PI/180, p2 = lat2 * Math.PI/180, dp = (lat2-lat1)*Math.PI/180, dl = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dp/2)**2 + Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const setStatus = (msg, type) => {
            const el = document.getElementById('status-message');
            if (el) { el.textContent = msg; el.className = `text-sm font-medium ${type === 'error' ? 'text-red-600' : 'text-blue-600'}`; }
        };

        const showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-input-container').classList.add('hidden');
            document.getElementById('modal-image-container').classList.add('hidden');
            document.getElementById('modal-cancel-btn').classList.add('hidden');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.textContent = "OK";
            confirmBtn.onclick = closeModal;
            const m = document.getElementById('custom-modal');
            m.classList.remove('opacity-0', 'pointer-events-none');
            m.querySelector('div').classList.remove('scale-95');
        };

        const closeModal = () => { const m = document.getElementById('custom-modal'); m.classList.add('opacity-0', 'pointer-events-none'); m.querySelector('div').classList.add('scale-95'); };
        const viewQR = () => {
            document.getElementById('modal-title').textContent = "Check-In QR";
            document.getElementById('modal-message').textContent = "";
            document.getElementById('modal-image-container').classList.remove('hidden');
            document.getElementById('modal-cancel-btn').classList.add('hidden');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.textContent = "Close";
            confirmBtn.onclick = closeModal;
            const m = document.getElementById('custom-modal');
            m.classList.remove('opacity-0', 'pointer-events-none');
            m.querySelector('div').classList.remove('scale-95');
        };

        const toggleLoading = (show) => document.getElementById('loading-spinner').classList.toggle('hidden', !show);
        const toggleLeaveForm = () => document.getElementById('leave-form-container').classList.toggle('hidden-section');

        const requestReset = () => {
            document.getElementById('modal-title').textContent = "Admin Reset";
            document.getElementById('modal-message').textContent = "Enter PIN:";
            document.getElementById('modal-input-container').classList.remove('hidden');
            document.getElementById('modal-cancel-btn').classList.remove('hidden');
            document.getElementById('modal-input').value = "";
            const confirmBtn = document.getElementById('modal-confirm-btn');
            confirmBtn.textContent = "Reset";
            confirmBtn.onclick = () => { if (document.getElementById('modal-input').value === ADMIN_RESET_PIN) { localStorage.clear(); window.location.reload(); } else { showModal('Error', 'Wrong PIN'); } };
            const m = document.getElementById('custom-modal');
            m.classList.remove('opacity-0', 'pointer-events-none');
        };

        document.getElementById('leave-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submit-leave-btn');
            btn.disabled = true; btn.textContent = "Syncing...";
            await syncToSheets('leave_request', { staffId: currentUser.id, staffName: currentUser.name, type: document.getElementById('leave-type').value, start: document.getElementById('leave-start-date').value, end: document.getElementById('leave-end-date').value, reason: document.getElementById('leave-reason').value });
            btn.disabled = false; btn.textContent = "Submit Request";
            showModal('Success', 'Request sent.');
            toggleLeaveForm();
            e.target.reset();
        });

        window.onload = () => { const saved = localStorage.getItem('kctec_checkin_user'); if (saved) { currentUser = JSON.parse(saved); showApp(); } };
    </script>
</body>
</html>
